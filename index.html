<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AAP.Electroconversor</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root{
  --brand:#2b8fd3;
  --line:#7ec3f1;
  --green:#6fb36a;
  --green2:#5aa955;
  --text:#374151;
  --muted:#6b7280;
}

body{
  margin:0;
  font-family: Arial, sans-serif;
}

.fundo{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:url("fundo.jpeg") no-repeat center center;
  background-size:cover;
  opacity:0.25;
  z-index:-1;
}

/* Layout */
.container{
  padding-top: 3.5rem;
  padding-bottom: 3.5rem;
}

/* Card flutuante */
.app-card{
  border-radius: 24px;
  border: none;
  box-shadow: 0 30px 70px rgba(0,0,0,.10);
  padding: 28px;
  background: rgba(255,255,255,0.97);
  backdrop-filter: blur(6px);
}

@media (max-width: 576px){
  .app-card{ padding:18px; border-radius:18px; }
  .container{ padding-top: 2.5rem; padding-bottom: 2.5rem; }
}

.logo{
  height: 78px;
  width:auto;
  border-radius: 12px;
  box-shadow: 0 6px 15px rgba(10,1,59,.12);
  object-fit: cover;
}
@media (max-width: 576px){
  .logo{ height: 62px; }
}

.app-title{
  font-size: 1.55rem;
  font-weight: 800;
  color:var(--brand);
  line-height:1.1;
}

.title-lines{
  margin:8px auto 0;
  max-width:210px;
}

.title-lines div{
  height:3px;
  background:var(--line);
  border-radius:10px;
  margin-top:8px;
}
.title-lines .l1{ width:180px; }
.title-lines .l2{ width:130px; opacity:.7; }

.form-label{
  font-weight:700;
  color:#4b5563;
  margin-bottom:.35rem;
}

.form-control, .form-select{
  border:1.5px solid var(--green);
  border-radius:12px;
  padding:10px 10px;
}

.form-control:focus, .form-select:focus{
  box-shadow:0 0 0 .15rem rgba(111,179,106,.2);
  border-color:var(--green2);
}

.resultado{
  font-size:1rem;
  font-weight:700;
  color:var(--text);
  min-height: 44px;
}

.alert-mini{
  font-size:.9rem;
  color:#b91c1c;
  font-weight:700;
}

.btn{
  border-radius:12px;
  font-weight:700;
}

/* Botão Novo */
.btn-novo{
  background-color:#636e68d3;
  border:none;
  color:white;
  transition:.2s ease;
}
.btn-novo:hover{
  background-color:#4e7a60;
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(0,0,0,.12);
}

.linha-preco{
  display:flex;
  align-items:center;
  gap:10px;
}
.linha-preco .rotulo-euro{
  margin-left:auto;
  font-weight:800;
  color:var(--muted);
}

/* Modal/tabela */
.table thead th{
  color:#4b5563;
  white-space: nowrap;
}
.table td{
  vertical-align: middle;
}
.mono{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
}
.badge-soft{
  background:#eef2ff;
  color:#3730a3;
  border:1px solid #c7d2fe;
  font-weight:800;
}

/* Barcode: botão Copiar só no hover (desktop) */
.barcode-cell{
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.btn-copy-hover{
  opacity: 0;
  pointer-events: none;
  transition: .15s ease;
}
tr:hover .btn-copy-hover,
.barcode-cell:hover .btn-copy-hover{
  opacity: 1;
  pointer-events: auto;
}
/* Mobile: sem hover => mostra sempre */
@media (max-width: 576px){
  .btn-copy-hover{
    opacity: 1 !important;
    pointer-events: auto !important;
  }
}
</style>
</head>

<body>
<div class="fundo"></div>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-5 col-md-7 col-sm-10">

      <div class="app-card">

        <!-- Cabeçalho (responsivo) -->
        <div class="d-flex align-items-center gap-3 mb-3">
          <img src="LOGO.png" class="logo" alt="Logo">
          <div class="flex-grow-1 text-center">
            <div class="app-title">AAP.Conversor.Digital</div>
            <div class="title-lines">
              <div class="l1"></div>
              <div class="l2"></div>
            </div>
          </div>
        </div>

        <div id="msgErro" class="alert-mini mb-2" style="display:none;"></div>

        <!-- Tipo -->
        <div class="mb-3">
          <label class="form-label">Tipo de cabo</label>
          <div class="row g-2">
            <div class="col-6">
              <select class="form-select" id="bitola">
                <option value="">Bitola</option>
                <option value="1.5">1.5 mm²</option>
                <option value="2.5">2.5 mm²</option>
                <option value="4">4 mm²</option>
                <option value="6">6 mm²</option>
                <option value="10">10 mm²</option>
              </select>
            </div>
            <div class="col-6">
              <select class="form-select" id="cor">
                <option value="">Cor</option>
                <option>Castanho</option>
                <option>Preto</option>
                <option>Azul</option>
                <option>Amarelo/Verde</option>
                <option>Verde/Amarelo</option>
                <option>Cinzento</option>
                <option>Cinza</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Peso / Barcode -->
        <div class="mb-3">
          <label class="form-label">Peso por metro</label>
          <div class="row g-2">
            <div class="col-6">
              <input type="number" step="0.0001" class="form-control" id="pesoPorMetro" placeholder="Ex: 0.019">
            </div>
            <div class="col-6">
              <input type="text" class="form-control" id="barcode" placeholder="Código de barras">
            </div>
          </div>
        </div>

        <!-- Preço -->
        <div class="mb-3">
          <div class="linha-preco">
            <label class="form-label m-0">Custo por metro</label>
            <span class="rotulo-euro">€</span>
          </div>
          <input type="number" step="0.01" class="form-control mt-2" id="precoMetro" placeholder="Preço opcional">
        </div>

        <!-- Peso compra -->
        <div class="mb-3">
          <label class="form-label">Peso por comprar</label>
          <div class="row g-2">
            <div class="col-6">
              <input type="number" step="0.01" class="form-control" id="pesoPedaco" placeholder="Peso">
            </div>
            <div class="col-6">
              <select class="form-select" id="unidadePeso">
                <option value="kg">Kg</option>
                <option value="g" selected>g</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Botões -->
        <div class="d-grid gap-2">
          <button class="btn btn-novo" id="btnNovo">Novo</button>
          <button class="btn btn-outline-secondary" id="btnConsultar">Consultar</button>
        </div>

        <hr>

        <div class="resultado text-center">
          <div id="resultadoMetros"></div>
          <div id="resultadoPreco" class="text-muted" style="font-weight:800;"></div>
        </div>

      </div>

    </div>
  </div>
</div>

<!-- Modal Consulta -->
<div class="modal fade" id="modalConsulta" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content" style="border-radius:18px;">
      <div class="modal-header">
        <h5 class="modal-title">Consulta de Registos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
          <button class="btn btn-outline-danger btn-sm" type="button" onclick="apagarTudo()">Apagar tudo</button>

          <div class="ms-auto d-flex flex-wrap gap-2 align-items-center">
            <span class="badge badge-soft" id="qtdRegistos">0 registo(s)</span>
            <input class="form-control form-control-sm" id="pesquisa" style="min-width:220px" placeholder="Pesquisar (bitola, cor, barcode)">
            <select class="form-select form-select-sm" id="ordenacao" style="min-width:180px">
              <option value="novo">Mais recente</option>
              <option value="antigo">Mais antigo</option>
              <option value="bitola">Bitola</option>
              <option value="preco">Preço total</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Bitola</th>
                <th>Cor</th>
                <th>Peso/m</th>
                <th>Comprimento (m)</th>
                <th>Preço Total (€)</th>
                <th>Barcode</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyRegistos"></tbody>
          </table>
        </div>

        <div class="text-muted mt-2" style="font-size:.85rem;">
          * Os registos ficam guardados neste navegador (sem base de dados).
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ===== DADOS =====
   peso = KG por metro
   Os novos (4/6/10) foram convertidos do rolo de 100m:
   4mm: 4.40/100 = 0.044
   6mm: 6.50/100 = 0.065
   10mm: 10.82/100 = 0.1082
*/
const cabos = {
  "1.5":{
    "Castanho":{peso:0.019,preco:0.300,barcode:"0607001915100"},
    "Preto":{peso:0.019,preco:0.300,barcode:"0607001811826"},
    "Azul":{peso:0.019,preco:0.300,barcode:"0607001915000"},
    "Amarelo/Verde":{peso:0.019,preco:0.310,barcode:"0607001915200"},
    "Cinzento":{peso:0.019,preco:0.300,barcode:"2122000035878"}
  },
  "2.5":{
    "Castanho":{peso:0.0304,preco:0.480,barcode:"2122000002650"},
    "Preto":{peso:0.0304,preco:0.480,barcode:"0607001920058"},
    "Azul":{peso:0.0304,preco:0.480,barcode:"0607001920051"},
    "Amarelo/Verde":{peso:0.0304,preco:0.480,barcode:"0607001920054"}
  },

  /* ===== ADICIONADO: 4 mm² ===== */
  "4":{
    "Cinza":{peso:0.0440,preco:0.840,barcode:"0607001920059"},
    "Azul":{peso:0.0440,preco:0.840,barcode:"0607001920056"},
    "Castanho":{peso:0.0440,preco:0.840,barcode:"0607001920058"},
    "Verde/Amarelo":{peso:0.0440,preco:0.840,barcode:"0607001920055"},
    "Amarelo/Verde":{peso:0.0440,preco:0.840,barcode:"0607001920055"},
    "Preto":{peso:0.0440,preco:0.840,barcode:"0607001920057"}
  },

  /* ===== ADICIONADO: 6 mm² ===== */
  "6":{
    "Cinza":{peso:0.0650,preco:1.210,barcode:"000033"},
    "Azul":{peso:0.0650,preco:1.210,barcode:"0607001920062"},
    "Castanho":{peso:0.0650,preco:1.210,barcode:"000032"},
    "Verde/Amarelo":{peso:0.0650,preco:1.210,barcode:"0607001920061"},
    "Amarelo/Verde":{peso:0.0650,preco:1.210,barcode:"0607001920061"},
    "Preto":{peso:0.0650,preco:1.210,barcode:"0607001920060"}
  },

  /* ===== ADICIONADO: 10 mm² ===== */
  "10":{
    "Verde/Amarelo":{peso:0.1082,preco:1.770,barcode:"0607001920065"},
    "Amarelo/Verde":{peso:0.1082,preco:1.770,barcode:"0607001920065"}
  }
};

const STORAGE_KEY="aap_registos_v2";

/* ===== ELEMENTOS ===== */
const bitola = document.getElementById("bitola");
const cor = document.getElementById("cor");
const pesoPorMetro = document.getElementById("pesoPorMetro");
const barcode = document.getElementById("barcode");
const precoMetro = document.getElementById("precoMetro");
const pesoPedaco = document.getElementById("pesoPedaco");
const unidadePeso = document.getElementById("unidadePeso");

const resultadoMetros = document.getElementById("resultadoMetros");
const resultadoPreco = document.getElementById("resultadoPreco");
const msgErro = document.getElementById("msgErro");

const btnNovo = document.getElementById("btnNovo");
const btnConsultar = document.getElementById("btnConsultar");

function showErro(txt){
  if(!txt){
    msgErro.style.display="none";
    msgErro.textContent="";
    return;
  }
  msgErro.style.display="block";
  msgErro.textContent=txt;
}

function toKg(value, unidade){
  const n = Number(value);
  if(!isFinite(n)) return null;
  return unidade === "g" ? (n/1000) : n;
}

function num(v){
  const n = Number(v);
  return isFinite(n) ? n : null;
}

function round2(n){ return (Math.round(n*100)/100).toFixed(2); }
function round4(n){ return (Math.round(n*10000)/10000).toFixed(4); }

/* ===== AUTO-PREENCHER (BITOLA+COR) =====
   Preenche automaticamente SEM remover nada: quando existir no dicionário, overwrite peso/preço/barcode.
*/
function preencherAuto(){
  if(cabos[bitola.value] && cabos[bitola.value][cor.value]){
    const item = cabos[bitola.value][cor.value];
    pesoPorMetro.value = item.peso;
    precoMetro.value   = item.preco;
    barcode.value      = item.barcode;
  }
  calcular();
}

/* ===== CÁLCULO ===== */
function calcular(){
  showErro("");

  const ppm = num(pesoPorMetro.value);         // kg por metro
  const peso = toKg(pesoPedaco.value, unidadePeso.value);
  const preco = num(precoMetro.value);         // €/m (opcional)

  if(!ppm || !peso){
    resultadoMetros.textContent="";
    resultadoPreco.textContent="";
    return null;
  }

  if(ppm <= 0 || peso <= 0){
    resultadoMetros.textContent="";
    resultadoPreco.textContent="";
    showErro("Valores inválidos. Verifique Peso por metro e Peso por comprar.");
    return null;
  }

  const metros = peso / ppm;
  resultadoMetros.textContent = "Comprimento: " + round2(metros) + " m";

  if(preco){
    const total = metros * preco;
    resultadoPreco.textContent = "Preço total: € " + round2(total);
    return { metros, total, ppm };
  }else{
    resultadoPreco.textContent = "Preço total: Não inserido";
    return { metros, total: null, ppm };
  }
}

/* ===== STORAGE ===== */
function lerRegistos(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  }catch(e){
    return [];
  }
}

function guardarRegistos(lista){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
}

/* ===== NOVO REGISTO ===== */
function novoRegistro(){
  const r = calcular();
  if(!bitola.value || !cor.value || !r) return;

  const lista = lerRegistos();
  lista.unshift({
    ts: Date.now(),
    bitola: bitola.value,
    cor: cor.value,
    ppm: r.ppm,
    comprimento: Number(r.metros.toFixed(2)),
    precoTotal: r.total ? Number(r.total.toFixed(2)) : null,
    barcode: barcode.value
  });

  guardarRegistos(lista);
  limparCampos();
}

function limparCampos(){
  bitola.value="";
  cor.value="";
  pesoPorMetro.value="";
  barcode.value="";
  precoMetro.value="";
  pesoPedaco.value="";
  unidadePeso.value="g";
  resultadoMetros.textContent="";
  resultadoPreco.textContent="";
}

/* ===== COPIAR BARCODE ===== */
function copiarTexto(txt){
  if(!txt) return;

  // navigator.clipboard (moderno)
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(txt).catch(()=>{});
    return;
  }

  // fallback
  const ta = document.createElement("textarea");
  ta.value = txt;
  ta.style.position = "fixed";
  ta.style.left = "-9999px";
  document.body.appendChild(ta);
  ta.select();
  try{ document.execCommand("copy"); }catch(e){}
  document.body.removeChild(ta);
}

/* ===== CONSULTA ===== */
function abrirConsulta(){
  renderTabela();
  const modalEl = document.getElementById("modalConsulta");
  const modal = new bootstrap.Modal(modalEl);
  modal.show();
  setTimeout(()=>document.getElementById("pesquisa")?.focus(), 150);
}

function formatPreco(v){
  return (v===null) ? "Não inserido" : v.toFixed(2);
}

function filtrarOrdenar(lista){
  const q = (document.getElementById("pesquisa").value || "").trim().toLowerCase();
  const ord = document.getElementById("ordenacao").value;

  let out = [...lista];

  if(q){
    out = out.filter(r=>{
      const s = `${r.bitola} ${r.cor} ${r.barcode||""}`.toLowerCase();
      return s.includes(q);
    });
  }

  if(ord === "antigo") out.sort((a,b)=>a.ts-b.ts);
  if(ord === "novo") out.sort((a,b)=>b.ts-a.ts);
  if(ord === "bitola") out.sort((a,b)=>Number(a.bitola)-Number(b.bitola));
  if(ord === "preco") out.sort((a,b)=>{
    const ap = (a.precoTotal ?? -1);
    const bp = (b.precoTotal ?? -1);
    return bp - ap;
  });

  return out;
}

function renderTabela(){
  const tbody = document.getElementById("tbodyRegistos");
  const qtd = document.getElementById("qtdRegistos");
  const lista = lerRegistos();
  const vis = filtrarOrdenar(lista);

  qtd.textContent = `${vis.length} registo(s)`;

  if(!vis.length){
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center text-muted py-4">
          Sem registos ainda. Faça um cálculo e clique em <b>Novo</b>.
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = vis.map((r,i)=>{
    const bc = r.barcode ? r.barcode : "-";
    const temBC = !!r.barcode;

    // protege aspas simples no onclick
    const safeBC = temBC ? String(r.barcode).replace(/'/g, "\\'") : "";

    return `
      <tr>
        <td>${i+1}</td>
        <td>${r.bitola} mm²</td>
        <td>${r.cor}</td>
        <td>${round4(r.ppm)}</td>
        <td>${Number(r.comprimento).toFixed(2)}</td>
        <td>${formatPreco(r.precoTotal)}</td>
        <td class="mono">
          ${
            temBC
            ? `
              <span class="barcode-cell">
                <span>${bc}</span>
                <button class="btn btn-outline-secondary btn-sm btn-copy-hover"
                        type="button"
                        onclick="copiarTexto('${safeBC}')">
                  Copiar
                </button>
              </span>
            `
            : `<span class="text-muted">-</span>`
          }
        </td>
        <td>
          <button class="btn btn-outline-danger btn-sm" onclick="removerItem(${r.ts})">Remover</button>
        </td>
      </tr>
    `;
  }).join("");
}

function removerItem(ts){
  const lista = lerRegistos();
  const idx = lista.findIndex(x=>x.ts===ts);
  if(idx>=0) lista.splice(idx,1);
  guardarRegistos(lista);
  renderTabela();
}

function apagarTudo(){
  if(!confirm("Tem certeza que quer apagar todos os registos?")) return;
  guardarRegistos([]);
  renderTabela();
}

/* ===== EVENTOS ===== */
bitola.addEventListener("change", preencherAuto);
cor.addEventListener("change", preencherAuto);
pesoPorMetro.addEventListener("input", calcular);
precoMetro.addEventListener("input", calcular);
pesoPedaco.addEventListener("input", calcular);
unidadePeso.addEventListener("change", calcular);

btnNovo.addEventListener("click", novoRegistro);
btnConsultar.addEventListener("click", abrirConsulta);

document.getElementById("pesquisa").addEventListener("input", renderTabela);
document.getElementById("ordenacao").addEventListener("change", renderTabela);
</script>

</body>
</html>
